<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.com.chinalife.ecdata.dao.sqlDao.fupin.OrderStatDao">

    <select id="getOrderStatListForTimeSpanFromStatTable" resultType="OrderStat" parameterType="QueryPara">
        SELECT p.id productId,p.NAME productName,count(*) orderNum,sum(og.number) goodsNum,sum(ob.money_amount)
        orderAmount,
        round(sum(ob.money_amount)/count(*),2) orderAverage
        FROM order_book ob
        INNER JOIN order_goods og ON ob.order_no = og.order_no
        AND ob. STATUS IN (3, 4, 5)
        AND ob.create_time >= concat(#{startDate},' 00:00:00')
        <![CDATA[
                    AND ob.create_time <= concat(#{endDate},' 23:59:59')
        ]]>
        INNER JOIN product p ON og.product_id = p.id AND p.fuping = 1
        <if test="whereCondition != null and whereCondition != ''">
            AND p.id IN ${whereCondition}
        </if>
        GROUP BY p.id,p. NAME ORDER BY orderNum DESC
    </select>

    <select id="getOrderStatListForTimeSpanTrendFromStatTable" resultType="OrderStat" parameterType="QueryPara">
         SELECT '所有商品' productName,
          count(IF(date(ob.create_time)=DATE_SUB(CURDATE(),INTERVAL 7 DAY),1,NULL)) orderNum7,
         count(IF(date(ob.create_time)=DATE_SUB(CURDATE(),INTERVAL 6 DAY),1,NULL)) orderNum6,
         count(IF(date(ob.create_time)=DATE_SUB(CURDATE(),INTERVAL 5 DAY),1,NULL)) orderNum5,
         count(IF(date(ob.create_time)=DATE_SUB(CURDATE(),INTERVAL 4 DAY),1,NULL)) orderNum4,
         count(IF(date(ob.create_time)=DATE_SUB(CURDATE(),INTERVAL 3 DAY),1,NULL)) orderNum3,
         count(IF(date(ob.create_time)=DATE_SUB(CURDATE(),INTERVAL 2 DAY),1,NULL)) orderNum2,
         count(IF(date(ob.create_time)=DATE_SUB(CURDATE(),INTERVAL 1 DAY),1,NULL)) orderNum1
         FROM order_book ob
        INNER JOIN order_goods og ON ob.order_no = og.order_no
        AND ob. STATUS IN (3, 4, 5)
        AND ob.create_time >= concat(#{startDate},' 00:00:00')
        <![CDATA[
                    AND ob.create_time <= concat(#{endDate},' 23:59:59')
        ]]>
        INNER JOIN product p ON og.product_id = p.id AND p.fuping = 1
        GROUP BY '所有商品'
    </select>

    <select id="getOrderProductList" resultType="OrderStat">
        SELECT p.id productId,p.NAME productName
        FROM order_book ob
        INNER JOIN order_goods og ON ob.order_no = og.order_no
        AND ob. STATUS IN (3, 4, 5)
        INNER JOIN product p ON og.product_id = p.id AND p.fuping = 1
        GROUP BY p.id,p. NAME
    </select>

    <select id="getOnlineRetailOrderIPList" resultType="OrderStat" parameterType="QueryPara">
        SELECT date(create_time) statDate,create_ip ip,'D' statDateSpan
        FROM order_book ob
        WHERE ob.create_time >= concat(#{startDate},' 00:00:00')
        <![CDATA[
                    AND ob.create_time <= concat(#{endDate},' 23:59:59')
        ]]>
        AND ob.seller_id IN ${whereCondition} AND ob.status not IN (6,7,8) AND LENGTH(ob.create_ip)>0
    </select>


    <select id="getOnlineGroupBuyOrderIPList" resultType="OrderStat" parameterType="QueryPara">
        SELECT date(o.create_time) statDate,GROUP_CONCAT(DISTINCT o.create_ip) ip,'D' statDateSpan
        FROM jicai_order o INNER JOIN jicai_order_goods g ON o.order_no = g.jicai_order_no
        WHERE o.create_time >= concat(#{startDate},' 00:00:00')
        <![CDATA[
                    AND o.create_time <= concat(#{endDate},' 23:59:59')
        ]]>
        AND o.seller_id IN ${whereCondition} AND o.status IN (3, 4, 5, 6, 7) AND LENGTH(o.create_ip)>0 AND g.status in(0,2) AND o.order_type = 0 GROUP BY o.order_no
    </select>

    <select id="getOrderStatCompanyDistributeList" resultType="OrderStat" parameterType="QueryPara">
        SELECT DISTRIBUTE_NAME disName,sum(INDEX_VALUE) indexValue
        FROM DMP_SELECT.FUPIN_DISTRIBUTE_RESULT
        WHERE
        <![CDATA[
			        STAT_TIME >= #{startDate}
		        ]]>
        <![CDATA[
                    and STAT_TIME <= #{endDate}
        ]]>
        AND DISTRIBUTE_TYPE='2'  AND INDEX_NAME='fupinOrderIPInfo'
        GROUP BY DISTRIBUTE_NAME ORDER BY sum(index_value) DESC
    </select>


    <select id="getOrderStatLocationDistributeList" resultType="OrderStat" parameterType="QueryPara">
        SELECT DISTRIBUTE_NAME disName,sum(INDEX_VALUE) indexValue
        FROM DMP_SELECT.FUPIN_DISTRIBUTE_RESULT
        WHERE
        <![CDATA[
			        STAT_TIME >= #{startDate}
		        ]]>
        <![CDATA[
                    and STAT_TIME <= #{endDate}
        ]]>
        AND DISTRIBUTE_TYPE='1'  AND INDEX_NAME='fupinOrderIPInfo'
        GROUP BY DISTRIBUTE_NAME ORDER BY sum(index_value) DESC
    </select>

    <select id="getFuPinSellerIDList" resultType="java.lang.String">
        SELECT SELLER_ID FROM FUPIN_SELLER_INFO
    </select>

    <select id="getOrderStatListForTimeSpan" resultType="OrderStat" parameterType="QueryPara">

    </select>

    <insert id="updateOrderStat" parameterType="java.util.List">
    </insert>

    <insert id="updateOrderIPInfo" parameterType="java.util.List">
        INSERT INTO DMP_SELECT.FUPIN_DISTRIBUTE_RESULT
        (STAT_TIME,STAT_TIME_SPAN, INDEX_NAME, DISTRIBUTE_TYPE, DISTRIBUTE_NAME,INDEX_VALUE,CREATE_TIME,UPDATE_TIME)
        SELECT t1.statDate,t1.statDateSpan,t1.indexName,t1.disType,t1.disName,t1.indexValue,t1.createTime,t1.updateTime
        FROM (
        <foreach collection="list" item="item" index="index" separator="UNION ALL">
            SELECT
            #{item.statDate,jdbcType=VARCHAR} statDate,
            #{item.statDateSpan,jdbcType=VARCHAR} statDateSpan,
            #{item.indexName,jdbcType=VARCHAR} indexName,
            #{item.disType,jdbcType=VARCHAR} disType,
            #{item.disName,jdbcType=VARCHAR} disName,
            #{item.indexValue,jdbcType=NUMERIC} indexValue,
            sysdate createTime,
            sysdate updateTime
            FROM dual
        </foreach>
        ) t1
    </insert>
</mapper>
