<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.com.chinalife.ecdata.dao.sqlDao.user.UserRetentionSQLDao">

    <insert id="insertListToDB" parameterType="java.util.List">
        INSERT INTO DMP_SELECT.RETENTION_RESULT
        (REGISTER_TIME,INDEX_SOURCE, RETENTION_TIME, INDEX_VALUE,CREATE_TIME,UPDATE_TIME)
        SELECT t1.registerTime,t1.userSource,t1.retentionTime,t1.retentionNum,t1.createTime,t1.updateTime FROM (
        <foreach collection="list" item="item" index="index" separator="UNION ALL">
            SELECT
            #{item.registerTime,jdbcType=VARCHAR} registerTime,
            #{item.userSource,jdbcType=VARCHAR} userSource,
            #{item.retentionTime,jdbcType=VARCHAR} retentionTime,
            #{item.retentionNum,jdbcType=NUMERIC} retentionNum,
            sysdate createTime,
            sysdate updateTime
            FROM dual
        </foreach>
        ) t1
    </insert>

    <select id="getActiveUserNumOfAllSourcesFromStatResultForTrendOfDate" resultType="ActiveUser"
            parameterType="QueryPara">
        SELECT INDEX_SOURCE userSource,SUM ( CASE WHEN STAT_TIME = to_char(sysdate-7,'yyyy-mm-dd') THEN INDEX_VALUE ELSE 0 END) activeUserNumOf7,
        SUM ( CASE WHEN STAT_TIME = to_char(sysdate-6,'yyyy-mm-dd') THEN INDEX_VALUE ELSE 0 END) activeUserNumOf6,
        SUM ( CASE WHEN STAT_TIME = to_char(sysdate-5,'yyyy-mm-dd') THEN INDEX_VALUE ELSE 0 END) activeUserNumOf5,
        SUM ( CASE WHEN STAT_TIME = to_char(sysdate-4,'yyyy-mm-dd') THEN INDEX_VALUE ELSE 0 END) activeUserNumOf4,
        SUM ( CASE WHEN STAT_TIME = to_char(sysdate-3,'yyyy-mm-dd') THEN INDEX_VALUE ELSE 0 END) activeUserNumOf3,
        SUM ( CASE WHEN STAT_TIME = to_char(sysdate-2,'yyyy-mm-dd') THEN INDEX_VALUE ELSE 0 END) activeUserNumOf2,
        SUM ( CASE WHEN STAT_TIME = to_char(sysdate-1,'yyyy-mm-dd') THEN INDEX_VALUE ELSE 0 END) activeUserNumOf1
        FROM DMP_SELECT.STAT_RESULT
        WHERE INDEX_NAME = 'activeNum'
        AND STAT_TIME_SPAN = 'D'
        <![CDATA[
			       and STAT_TIME >= #{startDate}
		        ]]>
        <![CDATA[
                    and STAT_TIME <= #{endDate}
        ]]>
        GROUP BY INDEX_SOURCE
    </select>

    <select id="getOldUserIdList" resultType="java.lang.String" parameterType="QueryPara">
        SELECT
        USERID
        FROM CHINALIFEEC.GE_USER_PERSONAL
        WHERE
        <![CDATA[
			        makedate >= TO_DATE(concat(#{queryDate},' 00:00:00'),'yyyy-mm-dd hh24:mi:ss')
		        ]]>
        <![CDATA[
                    and makedate <= TO_DATE(concat(#{queryDate},' 23:59:59'),'yyyy-mm-dd hh24:mi:ss')
        ]]>
        AND usersource = #{userSource}
    </select>

    <select id="getExistedRetentionRowNum" resultType="java.lang.Integer" parameterType="QueryPara">
        SELECT
        COUNT(*)
        FROM DMP_SELECT.RETENTION_RESULT
    </select>

    <select id="getRegisterNumFromStatResult" resultType="java.lang.Integer" parameterType="QueryPara">
        SELECT
        INDEX_VALUE
        FROM DMP_SELECT.STAT_RESULT
        WHERE STAT_TIME = #{queryDate} AND INDEX_SOURCE = #{userSource} AND INDEX_NAME = 'registerNum' AND STAT_TIME_SPAN = 'D'
    </select>
</mapper>
